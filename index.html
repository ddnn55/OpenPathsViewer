<!DOCTYPE html>
<meta charset="utf-8">
<title>Reprojected Raster Tiles</title>
<style>
@import url(../maps.css);

#map {
  position: relative;
  margin: 0 auto;
  overflow: hidden;
}

.layer-outer-container {
  opacity: 0.5;
  position: absolute;
  left: 0px;
  top: 0px;
}

.tile {
  position: absolute;
}

.points {
  fill: red;
}
</style>

<div id="map"></div>

<script src="stats.js"></script>

<script src="d3.v3.min.js"></script>
<script src="d3.geo.projection.min.js"></script>
<script src="topojson.min.js"></script>
<script src="d3.quadtiles.js"></script>
<script src="d3.geo.raster.js"></script>
<script>

var stats = new Stats();
stats.setMode(1); // 0: fps, 1: ms

// Align top-left
stats.domElement.style.position = 'absolute';
stats.domElement.style.left = '0px';
stats.domElement.style.top = '0px';

document.body.appendChild( stats.domElement );


var ratio = 1,
    width = 960 * ratio,
    height = 600 * ratio,
    p = .5;

var projection = d3.geo.albers()
    .rotate([0, 0])
    .center([0, 52])
    .scale(150 * ratio)
    .translate([width / 2, height / 2])
    .clipExtent([[p, p], [width - p, height - p]]);

var raster = d3.geo.raster(projection)
    .url("http://api.tiles.mapbox.com/v3/examples.map-zr0njcqy/{z}/{x}/{y}.png32");

var openPaths2GeoJson = function(op) {
  return {
    "type": "FeatureCollection",
    "features": op.map(function(d, i) {
      return {
        "type": "Feature",
        "geometry": {"type": "Point", "coordinates": [+d.lon, +d.lat]}
      }
    })
  }
}

var path = d3.geo.path().projection(projection);

var pointsG = d3.select("#map").append("svg").append("g")
      .attr("class", "points");

var layer = d3.select("#map")
    .style("width", width / ratio + "px")
    .style("height", height / ratio + "px")
    .call(d3.behavior.zoom()
      .translate([.5 * width / ratio, .5 * height / ratio])
      .scale(projection.scale() / ratio)
      .scaleExtent([1e2, 1e8])
      .on("zoom", function() {
        
        stats.end();

        var t = d3.event.translate,
            s = d3.event.scale;
        projection.translate([t[0] * ratio, t[1] * ratio]).scale(s * ratio);
        layer.call(raster);
        pointsG.select("path")
            .attr("d", path);

        stats.begin();

      }))
  .append("div")
    .attr("class", "layer-outer-container")
    .style(prefix + "transform-origin", "0 0 0")
  .append("div")
    .attr("class", "layer-inner-container")
    .style(prefix + "transform-origin", "0 0 0")
    .call(raster);

d3.csv("openpaths_davidstolarsky.csv", function(err, data) {
  
  data = data.filter(function(d, i) { return i % 10 == 0 })
  data = openPaths2GeoJson(data);

  console.log(data);

  pointsG.append("path")
    .datum(data)
    .attr("d", path);

  /*pointsG.selectAll("circle")
      .data(data)
    .enter().append("circle")
      .attr("transform", function(d) {
        return "translate(" + projection([d.lat, d.lon]).join(",") + ")"
      })*/

})

</script>
